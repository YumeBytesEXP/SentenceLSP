<!DOCTYPE html>
<html lang="en">
<head>
	<style>
		:root {
			--primary-bg:#1a1a1a;--secondary-bg:#202020;--accent-bg:#242424;--border-color:#45475a;--text-primary:#cdd6f4;--text-secondary:#6c7086;--accent-pink:#f38ba8;--accent-blue:#89b4fa;--accent-yellow:#f9e2af;--accent-green:#a6e3a1;--accent-purple:#cba6f7;--accent-cyan:#89dceb;--accent-orange:#fab387
		}
		*{box-sizing:border-box}
		html,body{background:linear-gradient(135deg,var(--primary-bg) 0%,var(--secondary-bg) 100%);width:100%;height:100%;margin:0;padding:0;overflow:hidden;font-family:'Cascadia Code','Fira Code','JetBrains Mono',consolas,monospace;color:var(--text-primary)}
		.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--primary-bg);display:flex;align-items:center;justify-content:center;z-index:10000;transition:opacity .2s ease}
		.loading-spinner{width:32px;height:32px;border:2px solid rgba(137,180,250,.3);border-top:2px solid var(--accent-blue);border-radius:50%;animation:spin .8s linear infinite}
		@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
		.editor-container{width:100%;height:100%;display:flex;flex-direction:column;position:relative;opacity:0;transition:opacity .2s ease}
		.editor-container.loaded{opacity:1}
		.toolbar{background:linear-gradient(135deg,#1c1c1c,#252525);backdrop-filter:blur(10px);border-bottom:1px solid rgba(69,71,90,.5);padding:6px 12px;display:flex;align-items:center;justify-content:space-between;height:42px;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.3)}
		.toolbar-section{display:flex;align-items:center;gap:8px}
		
		.toolbar-button{background:linear-gradient(145deg,#2a2a2a,#1f1f1f);border:1px solid rgba(255,255,255,.08);border-radius:6px;padding:6px 10px;color:var(--text-primary);cursor:pointer;transition:all .15s ease;font-size:11px;font-weight:500;display:inline-flex;align-items:center;gap:6px;position:relative;overflow:hidden;letter-spacing:.3px;min-width:auto;height:30px}
		.toolbar-button:hover{background:linear-gradient(145deg,#3a3a3a,#2f2f2f);border-color:rgba(137,180,250,.3);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
		.toolbar-button:active{transform:translateY(0);box-shadow:0 2px 8px rgba(0,0,0,.2)}
		.toolbar-button.active{background:linear-gradient(145deg,var(--accent-blue),#6c91f7);color:#fff;border-color:var(--accent-blue);box-shadow:0 0 12px rgba(137,180,250,.3)}
		.toolbar-button svg{width:14px;height:14px;fill:currentColor;transition:transform .15s ease}
		.toolbar-button:hover svg{transform:scale(1.05)}
		
		.lsp-badge{background:linear-gradient(135deg,#1a1a1a,#2d2d2d);border:1px solid #4a4a4a;border-radius:4px;padding:5px 12px;font-size:10px;font-weight:700;letter-spacing:.5px;position:relative;overflow:hidden;cursor:pointer;transition:all .15s ease;display:inline-flex;align-items:center;height:26px;box-shadow:0 2px 8px rgba(0,0,0,.4);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
		.lsp-badge span{background:linear-gradient(90deg,#a6e3a1,#74c7ec,#a6e3a1,#89b4fa,#a6e3a1);background-size:200% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:10px;animation:lspGlow 3s ease-in-out infinite}
		.lsp-badge.disconnected span{background:linear-gradient(90deg,#f38ba8,#fab387,#f38ba8);animation:errorPulse 2s ease-in-out infinite}
		@keyframes lspGlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
		@keyframes errorPulse{0%,100%{opacity:1}50%{opacity:.6}}
		.lsp-badge:hover{transform:scale(1.02);background:linear-gradient(135deg,#2a2a2a,#3d3d3d);border-color:#6a6a6a}
		
		.status-bar{
			position:fixed;
			bottom:0;
			left:0;
			right:0;
			background:linear-gradient(135deg,#1f1f1f,#2a2a2a);
			backdrop-filter:blur(10px);
			border-top:1px solid rgba(69,71,90,.5);
			padding:6px 16px;
			display:flex;
			align-items:center;
			justify-content:space-between;
			height:30px;
			font-size:11px;
			color:var(--text-secondary);
			z-index:1001
		}
		.status-item{display:flex;align-items:center;gap:6px}
		.status-indicator{width:8px;height:8px;border-radius:50%;background:var(--accent-green);animation:pulse 2s infinite}
		.status-indicator.disconnected{background:var(--accent-pink)}
		@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
		.notification{position:fixed;bottom:50px;right:20px;background:linear-gradient(135deg,#2a2a2a,#1f1f1f);backdrop-filter:blur(10px);border:1px solid rgba(69,71,90,.6);border-radius:6px;padding:8px 12px;color:var(--text-primary);font-size:11px;font-weight:500;box-shadow:0 4px 16px rgba(0,0,0,.3);transform:translateX(400px);transition:transform .2s ease;z-index:10001;display:flex;align-items:center;gap:6px;min-width:150px;max-width:280px;height:32px}
		.notification.show{transform:translateX(0)}
		.notification-icon{width:14px;height:14px;fill:var(--accent-green);flex-shrink:0}
		.notification.error .notification-icon{fill:var(--accent-pink)}
		.notification-close{margin-left:auto;cursor:pointer;width:12px;height:12px;fill:var(--text-secondary);transition:fill .15s ease;opacity:.7}
		.notification-close:hover{fill:var(--text-primary);opacity:1}
		.sidebar{position:absolute;left:0;top:42px;bottom:30px;width:280px;background:linear-gradient(145deg,rgba(26,26,26,.95),rgba(45,45,45,.95));backdrop-filter:blur(15px);border-right:1px solid rgba(74,74,74,.5);border-radius:0 12px 12px 0;box-shadow:4px 0 20px rgba(0,0,0,.4);transform:translateX(-100%);transition:transform .25s ease;z-index:999;overflow-y:auto}
		.sidebar.open{transform:translateX(0)}
		.sidebar-section{padding:20px 18px;border-bottom:1px solid rgba(74,74,74,.3);transition:background .15s ease}
		.sidebar-section:hover{background:rgba(255,255,255,.02)}
		.sidebar-section:last-child{border-bottom:none}
		.sidebar-title{color:#c0c0c0;font-weight:600;margin-bottom:16px;font-size:13px;letter-spacing:.5px;text-transform:uppercase;display:flex;align-items:center;gap:8px}
		.sidebar-title::before{content:'';width:3px;height:16px;background:linear-gradient(135deg,#c0c0c0,#808080);border-radius:2px}
		.setting-item{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding:12px 14px;font-size:12px;color:var(--text-primary);background:linear-gradient(145deg,#2a2a2a,#1f1f1f);border-radius:6px;border:1px solid rgba(74,74,74,.3);transition:all .15s ease;position:relative;overflow:hidden}
		.setting-item:hover{transform:translateX(4px);border-color:rgba(192,192,192,.3);background:linear-gradient(145deg,#3a3a3a,#2f2f2f)}
		.setting-item:last-child{margin-bottom:0}
		.setting-label{font-weight:500;color:#c0c0c0}
		.switch{position:relative;width:44px;height:24px;background:linear-gradient(135deg,#2a2a2a,#1a1a1a);border:2px solid rgba(74,74,74,.4);border-radius:12px;cursor:pointer;transition:all .2s ease;box-shadow:inset 0 2px 4px rgba(0,0,0,.3)}
		.switch:hover{border-color:rgba(192,192,192,.4)}
		.switch.active{background:linear-gradient(135deg,#606060,#404040);border-color:#808080}
		.switch::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:linear-gradient(135deg,#c0c0c0,#a0a0a0);border-radius:50%;transition:transform .2s ease;box-shadow:0 2px 6px rgba(0,0,0,.3)}
		.switch.active::after{transform:translateX(20px);background:linear-gradient(135deg,#fff,#e0e0e0)}
		.range-input{width:100px;height:6px;background:linear-gradient(90deg,#2a2a2a,#1a1a1a);border:1px solid rgba(74,74,74,.4);border-radius:3px;outline:none;appearance:none;cursor:pointer;transition:border-color .2s ease}
		.range-input:hover{border-color:rgba(192,192,192,.4)}
		.range-input::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;background:linear-gradient(135deg,#c0c0c0,#808080);border:2px solid #fff;border-radius:50%;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.4);transition:transform .15s ease}
		.range-input::-webkit-slider-thumb:hover{transform:scale(1.1);background:linear-gradient(135deg,#e0e0e0,#a0a0a0)}
		.sidebar::-webkit-scrollbar{width:6px}
		.sidebar::-webkit-scrollbar-track{background:transparent}
		.sidebar::-webkit-scrollbar-thumb{background:linear-gradient(135deg,rgba(192,192,192,.3),rgba(192,192,192,.5));border-radius:3px}
		.sidebar::-webkit-scrollbar-thumb:hover{background:linear-gradient(135deg,rgba(192,192,192,.5),rgba(192,192,192,.7))}
		
		.editor-wrapper{
			flex:1;
			position:relative;
			padding-bottom:30px
		}
		#container{width:100%;height:100%;border-radius:0;box-shadow:inset 0 0 20px rgba(137,180,250,.06),inset 0 0 10px rgba(137,180,250,.03);border:1px solid rgba(137,180,250,.1)}
		.error-message{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#dc2626,#991b1b);color:#fff;padding:20px 30px;border-radius:10px;font-family:monospace;font-size:14px;max-width:80%;text-align:center;z-index:10001;box-shadow:0 10px 40px rgba(0,0,0,.5)}
		
		/* LSP Status Panel */
		.lsp-panel{position:absolute;right:20px;top:50px;width:300px;background:linear-gradient(145deg,rgba(26,26,26,.95),rgba(45,45,45,.95));backdrop-filter:blur(15px);border:1px solid rgba(74,74,74,.5);border-radius:8px;padding:16px;transform:translateX(400px);transition:transform .25s ease;z-index:998;max-height:400px;overflow-y:auto}
		.lsp-panel.open{transform:translateX(0)}
		.lsp-panel h3{color:#c0c0c0;font-size:14px;margin:0 0 12px 0;display:flex;align-items:center;gap:8px}
		.lsp-status{display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px;background:rgba(255,255,255,.05);border-radius:4px}
		.lsp-logs{background:rgba(0,0,0,.3);border-radius:4px;padding:8px;font-size:10px;font-family:monospace;max-height:200px;overflow-y:auto;border:1px solid rgba(74,74,74,.3)}
		.log-entry{margin-bottom:4px;opacity:.8}
		.log-entry.error{color:var(--accent-pink)}
		.log-entry.info{color:var(--accent-blue)}
		.log-entry.success{color:var(--accent-green)}
		
		@media (max-width:768px){
			.toolbar{padding:4px 8px;height:38px}
			.toolbar-button{padding:5px 8px;font-size:10px;height:28px}
			.toolbar-button svg{width:12px;height:12px}
			.sidebar{width:240px}
			.notification{right:10px;bottom:45px;max-width:calc(100vw - 20px);font-size:10px;height:30px;padding:6px 10px}
			.lsp-badge{padding:4px 6px;font-size:9px;height:24px}
			.lsp-panel{width:280px;right:10px}
		}
		.editor-container,.sidebar{contain:layout style}
		
		/* Preload optimizations */
		.toolbar-button::before{display:none}
		.lsp-badge::after{display:none}
	</style>
	<meta charset="utf-8" />
	<title>LuaU Editor with LSP Support</title>
	<link rel="preconnect" href="https://cdnjs.cloudflare.com">
	<link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
</head>
<body>
	<div class="loading-overlay" id="loadingOverlay">
		<div class="loading-spinner"></div>
	</div>
	<div class="editor-container" id="editorContainer">
		<div class="toolbar">
			<div class="toolbar-section">
				<div class="toolbar-button" onclick="toggleSidebar()" title="Settings">
					<svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
				</div>
				<div class="toolbar-button" onclick="toggleMinimap()" title="Minimap">
					<svg viewBox="0 0 24 24"><path d="M15,7V3H9V7H3V9H21V7H15Z M21,11H3V21H21V11Z M9,19V13H15V19H9Z"/></svg>
				</div>
				<div class="toolbar-button" onclick="runDiagnostics()" title="Run Diagnostics">
					<svg viewBox="0 0 24 24"><path d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M13,17H11V15H13V17M13,13H11V7H13V13Z"/></svg>
				</div>
				<div class="toolbar-button" onclick="formatCode()" title="Format Code">
					<svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg>
				</div>
			</div>
			<div class="toolbar-section">
				<div class="lsp-badge" onclick="toggleLSPPanel()" title="LSP Status - Click for details" id="lspBadge">
					<span id="lspBadgeText">LSP Ready</span>
				</div>
			</div>
		</div>
		<div class="sidebar" id="sidebar">
			<div class="sidebar-section">
				<div class="sidebar-title">Editor Settings</div>
				<div class="setting-item">
					<span class="setting-label">Word Wrap</span>
					<div class="switch" onclick="toggleWordWrap(this)"></div>
				</div>
				<div class="setting-item">
					<span class="setting-label">Line Numbers</span>
					<div class="switch active" onclick="toggleLineNumbers(this)"></div>
				</div>
				<div class="setting-item">
					<span class="setting-label">Auto Save</span>
					<div class="switch active" onclick="toggleAutoSave(this)"></div>
				</div>
			</div>
			<div class="sidebar-section">
				<div class="sidebar-title">LSP Features</div>
				<div class="setting-item">
					<span class="setting-label">Auto Completion</span>
					<div class="switch active" onclick="toggleAutoCompletion(this)"></div>
				</div>
				<div class="setting-item">
					<span class="setting-label">Error Detection</span>
					<div class="switch active" onclick="toggleErrorDetection(this)"></div>
				</div>
				<div class="setting-item">
					<span class="setting-label">Hover Info</span>
					<div class="switch active" onclick="toggleHoverInfo(this)"></div>
				</div>
				<div class="setting-item">
					<span class="setting-label">Signature Help</span>
					<div class="switch active" onclick="toggleSignatureHelp(this)"></div>
				</div>
			</div>
			<div class="sidebar-section">
				<div class="sidebar-title">Appearance</div>
				<div class="setting-item">
					<span class="setting-label">Font Size</span>
					<input type="range" class="range-input" min="10" max="24" value="12" onchange="changeFontSize(this.value)">
				</div>
				<div class="setting-item">
					<span class="setting-label">Line Height</span>
					<input type="range" class="range-input" min="1" max="3" step="0.1" value="1.5" onchange="changeLineHeight(this.value)">
				</div>
			</div>
		</div>
		
		<!-- LSP Status Panel -->
		<div class="lsp-panel" id="lspPanel">
			<h3>
				<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
					<path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M7.07,18.28C7.5,17.38 8.12,16.5 8.91,15.77L10.32,17.18C9.75,17.96 9.33,18.81 9.08,19.69C8.54,19.25 8.05,18.78 7.62,18.25C7.44,18.27 7.26,18.28 7.07,18.28M18.93,18.28C18.74,18.28 18.56,18.27 18.38,18.25C17.95,18.78 17.46,19.25 16.92,19.69C16.67,18.81 16.25,17.96 15.68,17.18L17.09,15.77C17.88,16.5 18.5,17.38 18.93,18.28M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5Z"/>
				</svg>
				Language Server Status
			</h3>
			<div class="lsp-status">
				<div class="status-indicator" id="lspIndicator"></div>
				<span id="lspStatusText">Connected</span>
			</div>
			<div>
				<strong>Server Info:</strong>
				<div style="font-size:11px;margin-top:4px;color:var(--text-secondary)">
					Version: RobloxLSP v1.0.0<br>
					Features: Completion, Diagnostics, Hover, Signature Help
				</div>
			</div>
			<div style="margin-top:12px">
				<strong>Activity Log:</strong>
				<div class="lsp-logs" id="lspLogs">
					<div class="log-entry success">[12:34:56] LSP server initialized</div>
					<div class="log-entry info">[12:34:57] Roblox API loaded successfully</div>
					<div class="log-entry info">[12:34:58] Auto-completion enabled</div>
				</div>
			</div>
		</div>
		
		<div class="notification" id="customNotification">
			<svg class="notification-icon" viewBox="0 0 24 24">
				<path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/>
			</svg>
			<span id="notificationText"></span>
			<svg class="notification-close" viewBox="0 0 24 24" onclick="hideNotification()">
				<path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
			</svg>
		</div>
		<div class="editor-wrapper">
			<div id="container"></div>
		</div>
	</div>
	
	<div class="status-bar">
		<div class="status-item">
			<div class="status-indicator" id="mainStatusIndicator"></div>
			<span id="statusText">Initializing...</span>
		</div>
		<div style="display: flex; gap: 16px;">
			<div class="status-item">
				<span>Line: <span id="currentLine">1</span></span>
			</div>
			<div class="status-item">
				<span>Col: <span id="currentCol">1</span></span>
			</div>
			<div class="status-item">
				<span>LuaU + LSP</span>
			</div>
		</div>
	</div>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs/loader.min.js"></script>
	<script>
		let editor, editorLoaded = false, statusTimeout, notificationTimeout;
		let lspConnection = null, lspReady = false;
		let autoCompletionEnabled = true, errorDetectionEnabled = true, hoverInfoEnabled = true, signatureHelpEnabled = true;
		const els = {};
		
		// LSP Client Implementation
		class LSPClient {
			constructor() {
				this.messageId = 0;
				this.pendingRequests = new Map();
				this.isConnected = false;
				this.serverCapabilities = null;
			}
			
			// Mock WebSocket connection (replace with actual WebSocket to your LSP server)
			connect(url = 'ws://localhost:8080/lsp') {
				try {
					// For demo purposes, we'll simulate LSP connection
					// In real implementation, use: this.ws = new WebSocket(url);
					this.simulateConnection();
					return true;
				} catch (error) {
					console.error('LSP connection failed:', error);
					this.updateConnectionStatus(false, 'Connection failed');
					return false;
				}
			}
			
			simulateConnection() {
				// Simulate successful connection
				setTimeout(() => {
					this.isConnected = true;
					this.updateConnectionStatus(true, 'Connected');
					this.initialize();
					this.addLog('LSP server connected successfully', 'success');
				}, 1000);
			}
			
			updateConnectionStatus(connected, message) {
				this.isConnected = connected;
				const badge = document.getElementById('lspBadge');
				const badgeText = document.getElementById('lspBadgeText');
				const indicator = document.getElementById('lspIndicator');
				const statusText = document.getElementById('lspStatusText');
				
				if (badge && badgeText) {
					if (connected) {
						badge.classList.remove('disconnected');
						badgeText.textContent = 'LSP Ready';
					} else {
						badge.classList.add('disconnected');
						badgeText.textContent = 'LSP Error';
					}
				}
				
				if (indicator && statusText) {
					if (connected) {
						indicator.classList.remove('disconnected');
						statusText.textContent = message || 'Connected';
					} else {
						indicator.classList.add('disconnected');
						statusText.textContent = message || 'Disconnected';
					}
				}
			}
			
			initialize() {
				const initParams = {
					processId: null,
					clientInfo: { name: 'LuaU Editor', version: '1.0.0' },
					rootUri: null,
					capabilities: {
						textDocument: {
							completion: { completionItem: { snippetSupport: true } },
							hover: { contentFormat: ['markdown', 'plaintext'] },
							signatureHelp: { signatureInformation: { documentationFormat: ['markdown', 'plaintext'] } },
							publishDiagnostics: { relatedInformation: true },
							definition: { linkSupport: true },
							references: { context: { includeDeclaration: true } }
						},
						workspace: { workspaceFolders: true }
					}
				};
				
				// Simulate server response
				setTimeout(() => {
					this.serverCapabilities = {
						completionProvider: { triggerCharacters: ['.', ':', '('] },
						hoverProvider: true,
						signatureHelpProvider: { triggerCharacters: ['(', ','] },
						definitionProvider: true,
						referencesProvider: true,
						documentFormattingProvider: true,
						diagnosticProvider: true
					};
					
					lspReady = true;
					this.addLog('Server capabilities received', 'info');
					showNotification('LSP server ready!');
					
					// Start providing enhanced features
					this.setupEditorIntegration();
				}, 500);
			}
			
			setupEditorIntegration() {
				if (!editor || !editorLoaded) return;
				
				// Enhanced completion provider
				monaco.languages.registerCompletionItemProvider('lua', {
					provideCompletionItems: (model, position) => {
						if (!autoCompletionEnabled || !this.isConnected) return { suggestions: [] };
						
						const word = model.getWordUntilPosition(position);
						const range = {
							startLineNumber: position.lineNumber,
							endLineNumber: position.lineNumber,
							startColumn: word.startColumn,
							endColumn: word.endColumn
						};
						
						return this.getCompletionItems(model, position, range);
					},
					triggerCharacters: ['.', ':', '(']
				});
				
				// Hover provider
				monaco.languages.registerHoverProvider('lua', {
					provideHover: (model, position) => {
						if (!hoverInfoEnabled || !this.isConnected) return null;
						return this.getHoverInfo(model, position);
					}
				});
				
				// Signature help provider
				monaco.languages.registerSignatureHelpProvider('lua', {
					signatureHelpTriggerCharacters: ['(', ','],
					provideSignatureHelp: (model, position) => {
						if (!signatureHelpEnabled || !this.isConnected) return null;
						return this.getSignatureHelp(model, position);
					}
				});
				
				// Diagnostic provider (error detection)
				this.setupDiagnostics();
			}
			
			getCompletionItems(model, position, range) {
				// Enhanced Roblox/LuaU completion items
				const suggestions = [
					// Roblox Services
					{ label: 'game', kind: monaco.languages.CompletionItemKind.Variable, documentation: 'Root game object', range },
					{ label: 'workspace', kind: monaco.languages.CompletionItemKind.Variable, documentation: 'Game workspace', range },
					{ label: 'Players', kind: monaco.languages.CompletionItemKind.Variable, documentation: 'Players service', range },
					{ label: 'ReplicatedStorage', kind: monaco.languages.CompletionItemKind.Variable, documentation: 'Replicated storage service', range },
					{ label: 'RunService', kind: monaco.languages.CompletionItemKind.Variable, documentation: 'Run service for game loops', range },
					{ label: 'TweenService', kind: monaco.languages.CompletionItemKind.Variable, documentation: 'Service for tweening objects', range },
					{ label: 'UserInputService', kind: monaco.languages.CompletionItemKind.Variable, documentation: 'Handle user input', range },
					{ label: 'HttpService', kind: monaco.languages.CompletionItemKind.Variable, documentation: 'HTTP requests service', range },
					
					// Common Methods
					{ label: 'GetService', kind: monaco.languages.CompletionItemKind.Method, insertText: 'GetService("${1:ServiceName}")', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'FindFirstChild', kind: monaco.languages.CompletionItemKind.Method, insertText: 'FindFirstChild("${1:Name}")', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'WaitForChild', kind: monaco.languages.CompletionItemKind.Method, insertText: 'WaitForChild("${1:Name}")', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'FindFirstChildOfClass', kind: monaco.languages.CompletionItemKind.Method, insertText: 'FindFirstChildOfClass("${1:ClassName}")', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'Clone', kind: monaco.languages.CompletionItemKind.Method, documentation: 'Clone this object', range },
					{ label: 'Destroy', kind: monaco.languages.CompletionItemKind.Method, documentation: 'Destroy this object', range },
					{ label: 'Connect', kind: monaco.languages.CompletionItemKind.Method, insertText: 'Connect(${1:function})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					
					// LuaU Keywords & Constructs
					{ label: 'function', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'function ${1:name}(${2:args})\\n\\t${3:-- code}\\nend', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'local function', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'local function ${1:name}(${2:args})\\n\\t${3:-- code}\\nend', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'if', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'if ${1:condition} then\\n\\t${2:-- code}\\nend', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'for', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'for ${1:i} = ${2:1}, ${3:10} do\\n\\t${4:-- code}\\nend', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'while', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'while ${1:condition} do\\n\\t${2:-- code}\\nend', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'repeat', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'repeat\\n\\t${1:-- code}\\nuntil ${2:condition}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					
					// Built-in Functions
					{ label: 'print', kind: monaco.languages.CompletionItemKind.Function, insertText: 'print(${1:value})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'warn', kind: monaco.languages.CompletionItemKind.Function, insertText: 'warn(${1:message})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'wait', kind: monaco.languages.CompletionItemKind.Function, insertText: 'wait(${1:seconds})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'spawn', kind: monaco.languages.CompletionItemKind.Function, insertText: 'spawn(${1:function})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'delay', kind: monaco.languages.CompletionItemKind.Function, insertText: 'delay(${1:seconds}, ${2:function})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					
					// Roblox Classes
					{ label: 'Part', kind: monaco.languages.CompletionItemKind.Class, documentation: 'A 3D part object', range },
					{ label: 'Script', kind: monaco.languages.CompletionItemKind.Class, documentation: 'A server script', range },
					{ label: 'LocalScript', kind: monaco.languages.CompletionItemKind.Class, documentation: 'A client-side script', range },
					{ label: 'ModuleScript', kind: monaco.languages.CompletionItemKind.Class, documentation: 'A reusable module script', range },
					{ label: 'RemoteEvent', kind: monaco.languages.CompletionItemKind.Class, documentation: 'For client-server communication', range },
					{ label: 'RemoteFunction', kind: monaco.languages.CompletionItemKind.Class, documentation: 'For client-server function calls', range },
					
					// Data Types
					{ label: 'Vector3', kind: monaco.languages.CompletionItemKind.Class, insertText: 'Vector3.new(${1:x}, ${2:y}, ${3:z})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'Vector2', kind: monaco.languages.CompletionItemKind.Class, insertText: 'Vector2.new(${1:x}, ${2:y})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'CFrame', kind: monaco.languages.CompletionItemKind.Class, insertText: 'CFrame.new(${1:position})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'Color3', kind: monaco.languages.CompletionItemKind.Class, insertText: 'Color3.new(${1:r}, ${2:g}, ${3:b})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range },
					{ label: 'UDim2', kind: monaco.languages.CompletionItemKind.Class, insertText: 'UDim2.new(${1:xScale}, ${2:xOffset}, ${3:yScale}, ${4:yOffset})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, range }
				];
				
				return { suggestions };
			}
			
			getHoverInfo(model, position) {
				const word = model.getWordAtPosition(position);
				if (!word) return null;
				
				// Roblox API hover information
				const hoverData = {
					'game': { value: '**game**: *DataModel*\\n\\nThe root object of the Roblox game hierarchy.' },
					'workspace': { value: '**workspace**: *Workspace*\\n\\nThe 3D world where all physical objects exist.' },
					'Players': { value: '**Players**: *Players*\\n\\nService that manages player objects.' },
					'print': { value: '**print**(*...any*)\\n\\nOutputs values to the console.' },
					'wait': { value: '**wait**(*number?*): *number*\\n\\nYields the current thread for the given time.' },
					'Vector3': { value: '**Vector3**: *Vector3*\\n\\nA 3D vector with x, y, z components.' },
					'Part': { value: '**Part**: *BasePart*\\n\\nA 3D geometric shape that can be placed in the workspace.' }
				};
				
				const info = hoverData[word.word];
				if (info) {
					return {
						range: new monaco.Range(position.lineNumber, word.startColumn, position.lineNumber, word.endColumn),
						contents: [{ value: info.value }]
					};
				}
				
				return null;
			}
			
			getSignatureHelp(model, position) {
				const line = model.getLineContent(position.lineNumber);
				const beforeCursor = line.substring(0, position.column - 1);
				
				// Simple signature detection
				if (beforeCursor.includes('Vector3.new(')) {
					return {
						signatures: [{
							label: 'Vector3.new(x: number, y: number, z: number): Vector3',
							documentation: 'Creates a new Vector3 with the given x, y, z coordinates.',
							parameters: [
								{ label: 'x: number', documentation: 'X coordinate' },
								{ label: 'y: number', documentation: 'Y coordinate' },
								{ label: 'z: number', documentation: 'Z coordinate' }
							]
						}],
						activeSignature: 0,
						activeParameter: 0
					};
				}
				
				if (beforeCursor.includes('print(')) {
					return {
						signatures: [{
							label: 'print(...any): void',
							documentation: 'Prints the given values to the output console.',
							parameters: [
								{ label: '...any', documentation: 'Values to print' }
							]
						}],
						activeSignature: 0,
						activeParameter: 0
					};
				}
				
				return null;
			}
			
			setupDiagnostics() {
				if (!editor || !editorLoaded) return;
				
				let diagnosticTimeout;
				const runDiagnostics = () => {
					if (!errorDetectionEnabled || !this.isConnected) return;
					
					clearTimeout(diagnosticTimeout);
					diagnosticTimeout = setTimeout(() => {
						const model = editor.getModel();
						const code = model.getValue();
						const diagnostics = this.analyzeLuaCode(code);
						
						// Convert to Monaco markers
						const markers = diagnostics.map(diag => ({
							startLineNumber: diag.range.start.line + 1,
							endLineNumber: diag.range.end.line + 1,
							startColumn: diag.range.start.character + 1,
							endColumn: diag.range.end.character + 1,
							message: diag.message,
							severity: diag.severity === 1 ? monaco.MarkerSeverity.Error : 
							          diag.severity === 2 ? monaco.MarkerSeverity.Warning : 
							          monaco.MarkerSeverity.Info
						}));
						
						monaco.editor.setModelMarkers(model, 'luau-lsp', markers);
						
						if (diagnostics.length > 0) {
							this.addLog(`Found ${diagnostics.length} diagnostic(s)`, 'info');
						}
					}, 1000);
				};
				
				editor.onDidChangeModelContent(runDiagnostics);
				runDiagnostics(); // Initial run
			}
			
			analyzeLuaCode(code) {
				const diagnostics = [];
				const lines = code.split('\\n');
				
				// Simple syntax checks
				lines.forEach((line, index) => {
					// Check for common mistakes
					if (line.includes('= nil') && line.includes('local')) {
						diagnostics.push({
							range: { start: { line: index, character: 0 }, end: { line: index, character: line.length } },
							message: 'Redundant nil assignment to local variable',
							severity: 2 // Warning
						});
					}
					
					if (line.match(/\\bfunction\\s+\\w+\\s*\\()/)) {
						if (!line.includes('local') && index > 0) {
							diagnostics.push({
								range: { start: { line: index, character: 0 }, end: { line: index, character: line.length } },
								message: 'Consider using local function for better performance',
								severity: 3 // Info
							});
						}
					}
					
					// Check for missing 'end' keywords (very basic)
					const openKeywords = (line.match(/\\b(function|if|for|while|repeat)\\b/g) || []).length;
					const closeKeywords = (line.match(/\\b(end|until)\\b/g) || []).length;
					
					if (line.trim() && openKeywords > closeKeywords && !line.includes('--')) {
						// This is a simplified check - a real LSP would do proper parsing
					}
				});
				
				return diagnostics;
			}
			
			addLog(message, type = 'info') {
				const logsContainer = document.getElementById('lspLogs');
				if (!logsContainer) return;
				
				const timestamp = new Date().toLocaleTimeString();
				const logEntry = document.createElement('div');
				logEntry.className = `log-entry ${type}`;
				logEntry.textContent = `[${timestamp}] ${message}`;
				
				logsContainer.appendChild(logEntry);
				logsContainer.scrollTop = logsContainer.scrollHeight;
				
				// Keep only last 50 entries
				while (logsContainer.children.length > 50) {
					logsContainer.removeChild(logsContainer.firstChild);
				}
			}
			
			formatDocument() {
				if (!editor || !editorLoaded) return;
				
				// Simple code formatting
				const model = editor.getModel();
				const code = model.getValue();
				const formatted = this.formatLuaCode(code);
				
				if (formatted !== code) {
					editor.setValue(formatted);
					this.addLog('Document formatted', 'success');
					showNotification('Code formatted');
				}
			}
			
			formatLuaCode(code) {
				// Very basic formatter - a real LSP would use proper AST parsing
				let lines = code.split('\\n');
				let indentLevel = 0;
				const indentSize = 4;
				
				const formatted = lines.map(line => {
					const trimmed = line.trim();
					if (!trimmed || trimmed.startsWith('--')) return line;
					
					// Decrease indent for closing keywords
					if (trimmed.match(/^(end|else|elseif|until)\\b/)) {
						indentLevel = Math.max(0, indentLevel - 1);
					}
					
					const indented = ' '.repeat(indentLevel * indentSize) + trimmed;
					
					// Increase indent for opening keywords
					if (trimmed.match(/\\b(function|if|for|while|repeat|else|elseif)\\b/) && !trimmed.match(/\\bend\\b/)) {
						indentLevel++;
					}
					
					return indented;
				});
				
				return formatted.join('\\n');
			}
		}
		
		// Initialize LSP client
		const lspClient = new LSPClient();
		
		// Fast element caching
		function cacheElements() {
			requestAnimationFrame(() => {
				els.sidebar = document.getElementById('sidebar');
				els.statusText = document.getElementById('statusText');
				els.currentLine = document.getElementById('currentLine');
				els.currentCol = document.getElementById('currentCol');
				els.loadingOverlay = document.getElementById('loadingOverlay');
				els.editorContainer = document.getElementById('editorContainer');
				els.customNotification = document.getElementById('customNotification');
				els.notificationText = document.getElementById('notificationText');
				els.lspPanel = document.getElementById('lspPanel');
				els.mainStatusIndicator = document.getElementById('mainStatusIndicator');
			});
		}
		
		function showError(msg) {
			const errorDiv = document.createElement('div');
			errorDiv.className = 'error-message';
			errorDiv.innerHTML = `<h3>Loading Error</h3><p>${msg}</p>`;
			document.body.appendChild(errorDiv);
			if (els.loadingOverlay) els.loadingOverlay.style.display = 'none';
		}
		
		function showNotification(msg, duration = 2500, isError = false) {
			if (!els.customNotification || !els.notificationText) return;
			els.notificationText.textContent = msg;
			els.customNotification.classList.toggle('error', isError);
			els.customNotification.classList.add('show');
			clearTimeout(notificationTimeout);
			notificationTimeout = setTimeout(() => hideNotification(), duration);
		}
		
		function hideNotification() {
			if (els.customNotification) els.customNotification.classList.remove('show');
		}
		
		function updateStatus(text, duration = 1500) {
			if (!els.statusText) return;
			els.statusText.textContent = text;
			clearTimeout(statusTimeout);
			statusTimeout = setTimeout(() => {
				if (els.statusText && editorLoaded) {
					els.statusText.textContent = lspReady ? 'LSP Ready' : 'Editor Ready';
				}
			}, duration);
		}
		
		function hideLoadingOverlay() {
			if (els.loadingOverlay) {
				els.loadingOverlay.style.opacity = '0';
				setTimeout(() => {
					els.loadingOverlay.style.display = 'none';
					els.editorContainer.classList.add('loaded');
				}, 200);
			}
		}
		
		// Monaco Editor initialization
		require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs' } });
		
		require(['vs/editor/editor.main'], function() {
			try {
				updateStatus('Loading editor...');
				
				// Enhanced LuaU theme
				monaco.editor.defineTheme('LuauLSPTheme', {
					base: 'vs-dark',
					inherit: true,
					rules: [
						{ token: 'comment', foreground: '6c7086', fontStyle: 'italic' },
						{ token: 'keyword', foreground: 'cba6f7', fontStyle: 'bold' },
						{ token: 'string', foreground: 'a6e3a1' },
						{ token: 'number', foreground: 'fab387' },
						{ token: 'function', foreground: 'f38ba8' },
						{ token: 'variable', foreground: 'cdd6f4' },
						{ token: 'type', foreground: '89b4fa' },
						{ token: 'constant', foreground: 'f9e2af' }
					],
					colors: {
						'editor.background': '#202020',
						'editor.foreground': '#cdd6f4',
						'editorCursor.foreground': '#f5e0dc',
						'editor.lineHighlightBackground': '#303030',
						'editorLineNumber.foreground': '#6c7086',
						'editor.selectionBackground': '#45475a',
						'editor.inactiveSelectionBackground': '#313244',
						'editorSuggestWidget.background': '#1e1e2e',
						'editorSuggestWidget.border': '#45475a',
						'editorHoverWidget.background': '#1e1e2e',
						'editorHoverWidget.border': '#45475a'
					}
				});
				
				// Enhanced editor configuration
				const editorConfig = {
					language: 'lua',
					theme: 'LuauLSPTheme',
					automaticLayout: true,
					minimap: { enabled: false },
					fontSize: 12,
					fontFamily: 'Cascadia Code, Fira Code, JetBrains Mono, consolas, monospace',
					fontLigatures: true,
					scrollBeyondLastLine: false,
					renderLineHighlight: 'all',
					wordWrap: 'off',
					smoothScrolling: true,
					cursorBlinking: 'smooth',
					cursorSmoothCaretAnimation: true,
					suggest: {
						showKeywords: true,
						showSnippets: true,
						localityBonus: true,
						insertMode: 'replace'
					},
					quickSuggestions: {
						other: true,
						comments: false,
						strings: true
					},
					parameterHints: {
						enabled: true,
						cycle: true
					},
					hover: {
						enabled: true,
						delay: 300
					},
					lightbulb: {
						enabled: true
					},
					codeActionsOnSave: {
						'source.fixAll': true
					},
					scrollbar: {
						useShadows: true,
						verticalScrollbarSize: 10,
						horizontalScrollbarSize: 10
					},
					bracketPairColorization: {
						enabled: true
					},
					guides: {
						bracketPairs: true,
						indentation: true
					}
				};
				
				editor = monaco.editor.create(document.getElementById('container'), editorConfig);
				
				// Cursor position tracking
				let lastUpdate = 0;
				editor.onDidChangeCursorPosition((e) => {
					const now = Date.now();
					if (now - lastUpdate > 50) {
						if (els.currentLine && els.currentCol) {
							els.currentLine.textContent = e.position.lineNumber;
							els.currentCol.textContent = e.position.column;
						}
						lastUpdate = now;
					}
				});
				
				// Auto-save functionality
				let changeTimeout;
				editor.onDidChangeModelContent(() => {
					clearTimeout(changeTimeout);
					changeTimeout = setTimeout(() => {
						updateStatus('Auto-saved', 1000);
						if (lspClient && lspReady) {
							lspClient.addLog('Document auto-saved', 'info');
						}
					}, 1000);
				});
				
				// Sample Roblox LuaU code
				const sampleCode = `-- Roblox LuaU Script Example
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local character = player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")

-- Create a part in workspace
local function createPart()
	local part = Instance.new("Part")
	part.Size = Vector3.new(4, 1, 2)
	part.Position = Vector3.new(0, 10, 0)
	part.BrickColor = BrickColor.new("Bright blue")
	part.Material = Enum.Material.Neon
	part.Parent = workspace
	
	-- Animate the part
	local tweenInfo = TweenInfo.new(
		2, -- Duration
		Enum.EasingStyle.Bounce,
		Enum.EasingDirection.Out,
		-1, -- Repeat count (-1 = infinite)
		true -- Reverse
	)
	
	local tween = TweenService:Create(
		part,
		tweenInfo,
		{Position = part.Position + Vector3.new(0, 5, 0)}
	)
	
	tween:Play()
	return part
end

-- Handle player input
local function onPlayerJumped()
	print(player.Name .. " jumped!")
	createPart()
end

-- Connect events
humanoid.Jumping:Connect(onPlayerJumped)

-- Game loop example
local heartbeat = RunService.Heartbeat:Connect(function(dt)
	-- This runs every frame
	-- dt is delta time since last frame
end)

print("Script loaded successfully!")`;
				
				editor.setValue(sampleCode);
				
				editorLoaded = true;
				hideLoadingOverlay();
				updateStatus('Editor ready, connecting LSP...');
				
				// Initialize LSP connection
				setTimeout(() => {
					lspClient.connect();
				}, 500);
				
				// Set up status indicator
				if (els.mainStatusIndicator) {
					els.mainStatusIndicator.classList.remove('disconnected');
				}
				
			} catch (error) {
				console.error('Editor error:', error);
				showError(`Failed to load editor: ${error.message}`);
			}
		}, function(error) {
			console.error('Monaco error:', error);
			showError('Failed to load Monaco Editor. Check your connection.');
		});
		
		// Window resize handler
		let resizeTimeout;
		window.addEventListener('resize', function() {
			clearTimeout(resizeTimeout);
			resizeTimeout = setTimeout(() => {
				if (editorLoaded && editor) editor.layout();
			}, 150);
		});
		
		// UI Functions
		window.toggleSidebar = () => els.sidebar?.classList.toggle('open');
		
		window.toggleLSPPanel = () => els.lspPanel?.classList.toggle('open');
		
		window.toggleMinimap = function() {
			if (!editorLoaded) return;
			const minimapEnabled = editor.getOptions().get(monaco.editor.EditorOption.minimap).enabled;
			editor.updateOptions({ minimap: { enabled: !minimapEnabled } });
			const button = document.querySelector('[onclick="toggleMinimap()"]');
			if (button) button.classList.toggle('active');
			showNotification(minimapEnabled ? 'Minimap disabled' : 'Minimap enabled');
		}
		
		window.runDiagnostics = function() {
			if (!lspReady || !lspClient) {
				showNotification('LSP not ready', 2000, true);
				return;
			}
			
			const button = document.querySelector('[onclick="runDiagnostics()"]');
			if (button) {
				button.classList.add('active');
				setTimeout(() => button.classList.remove('active'), 1000);
			}
			
			lspClient.setupDiagnostics();
			lspClient.addLog('Manual diagnostics triggered', 'info');
			showNotification('Running diagnostics...');
		}
		
		window.formatCode = function() {
			if (!lspReady || !lspClient) {
				showNotification('LSP not ready', 2000, true);
				return;
			}
			
			const button = document.querySelector('[onclick="formatCode()"]');
			if (button) {
				button.classList.add('active');
				setTimeout(() => button.classList.remove('active'), 1000);
			}
			
			lspClient.formatDocument();
		}
		
		window.changeFontSize = function(size) {
			if (!editorLoaded) return;
			editor.updateOptions({ fontSize: parseInt(size) });
			showNotification(`Font size: ${size}px`);
		}
		
		window.changeLineHeight = function(height) {
			if (!editorLoaded) return;
			editor.updateOptions({ lineHeight: parseFloat(height) });
			showNotification(`Line height: ${height}`);
		}
		
		window.toggleWordWrap = function(element) {
			if (!editorLoaded) return;
			element.classList.toggle('active');
			const wordWrap = element.classList.contains('active');
			editor.updateOptions({ wordWrap: wordWrap ? 'on' : 'off' });
			showNotification(`Word wrap ${wordWrap ? 'enabled' : 'disabled'}`);
		}
		
		window.toggleLineNumbers = function(element) {
			if (!editorLoaded) return;
			element.classList.toggle('active');
			const lineNumbers = element.classList.contains('active');
			editor.updateOptions({ lineNumbers: lineNumbers ? 'on' : 'off' });
			showNotification(`Line numbers ${lineNumbers ? 'enabled' : 'disabled'}`);
		}
		
		window.toggleAutoSave = function(element) {
			element.classList.toggle('active');
			const autoSave = element.classList.contains('active');
			showNotification(`Auto-save ${autoSave ? 'enabled' : 'disabled'}`);
		}
		
		window.toggleAutoCompletion = function(element) {
			element.classList.toggle('active');
			autoCompletionEnabled = element.classList.contains('active');
			if (lspClient) {
				lspClient.addLog(`Auto completion ${autoCompletionEnabled ? 'enabled' : 'disabled'}`, 'info');
			}
			showNotification(`Auto completion ${autoCompletionEnabled ? 'enabled' : 'disabled'}`);
		}
		
		window.toggleErrorDetection = function(element) {
			element.classList.toggle('active');
			errorDetectionEnabled = element.classList.contains('active');
			if (lspClient && lspReady) {
				if (errorDetectionEnabled) {
					lspClient.setupDiagnostics();
				} else {
					// Clear existing markers
					monaco.editor.setModelMarkers(editor.getModel(), 'luau-lsp', []);
				}
				lspClient.addLog(`Error detection ${errorDetectionEnabled ? 'enabled' : 'disabled'}`, 'info');
			}
			showNotification(`Error detection ${errorDetectionEnabled ? 'enabled' : 'disabled'}`);
		}
		
		window.toggleHoverInfo = function(element) {
			element.classList.toggle('active');
			hoverInfoEnabled = element.classList.contains('active');
			if (lspClient) {
				lspClient.addLog(`Hover info ${hoverInfoEnabled ? 'enabled' : 'disabled'}`, 'info');
			}
			showNotification(`Hover info ${hoverInfoEnabled ? 'enabled' : 'disabled'}`);
		}
		
		window.toggleSignatureHelp = function(element) {
			element.classList.toggle('active');
			signatureHelpEnabled = element.classList.contains('active');
			if (lspClient) {
				lspClient.addLog(`Signature help ${signatureHelpEnabled ? 'enabled' : 'disabled'}`, 'info');
			}
			showNotification(`Signature help ${signatureHelpEnabled ? 'enabled' : 'disabled'}`);
		}
		
		// API Functions for external integration
		window.GetText = function() {
			return editorLoaded ? editor.getValue() : '';
		}
		
		window.SetText = function(text) {
			if (editorLoaded) {
				editor.setValue(text || '');
				if (lspClient && lspReady) {
					lspClient.addLog('Document content updated externally', 'info');
				}
			}
		}
		
		window.SetTheme = function(theme) {
			if (editorLoaded) {
				const monacoTheme = theme === 'Dark' ? 'LuauLSPTheme' : 'vs';
				monaco.editor.setTheme(monacoTheme);
				if (lspClient) {
					lspClient.addLog(`Theme changed to ${theme}`, 'info');
				}
			}
		}
		
		window.GetLSPStatus = function() {
			return {
				connected: lspClient ? lspClient.isConnected : false,
				ready: lspReady,
				features: {
					completion: autoCompletionEnabled,
					diagnostics: errorDetectionEnabled,
					hover: hoverInfoEnabled,
					signatureHelp: signatureHelpEnabled
				}
			};
		}
		
		window.hideNotification = hideNotification;
		
		// Keyboard shortcuts
		document.addEventListener('keydown', function(e) {
			// Ctrl+S - Manual save
			if (e.ctrlKey && e.key === 's') {
				e.preventDefault();
				showNotification('Document saved');
				if (lspClient && lspReady) {
					lspClient.addLog('Manual save triggered', 'info');
				}
			}
			
			// Escape - Close panels
			if (e.key === 'Escape') {
				if (els.lspPanel?.classList.contains('open')) {
					toggleLSPPanel();
				} else if (els.sidebar?.classList.contains('open')) {
					toggleSidebar();
				} else if (els.customNotification?.classList.contains('show')) {
					hideNotification();
				}
			}
			
			// Ctrl+Shift+F - Format document
			if (e.ctrlKey && e.shiftKey && e.key === 'F') {
				e.preventDefault();
				formatCode();
			}
			
			// Ctrl+Shift+P - Command palette (LSP commands)
			if (e.ctrlKey && e.shiftKey && e.key === 'P') {
				e.preventDefault();
				if (editorLoaded) {
					editor.trigger('', 'editor.action.quickCommand', '');
				}
			}
			
			// F2 - Rename symbol
			if (e.key === 'F2') {
				e.preventDefault();
				if (editorLoaded && lspReady) {
					editor.trigger('', 'editor.action.rename', '');
					showNotification('Rename symbol (simulated)');
				}
			}
			
			// F12 - Go to definition
			if (e.key === 'F12') {
				e.preventDefault();
				if (editorLoaded && lspReady) {
					editor.trigger('', 'editor.action.revealDefinition', '');
					showNotification('Go to definition (simulated)');
				}
			}
			
			// Ctrl+Space - Trigger completion
			if (e.ctrlKey && e.key === ' ') {
				e.preventDefault();
				if (editorLoaded && autoCompletionEnabled) {
					editor.trigger('', 'editor.action.triggerSuggest', '');
				}
			}
		});
		
		// Context menu enhancements
		if (typeof monaco !== 'undefined') {
			// Add custom context menu actions when Monaco is loaded
			setTimeout(() => {
				if (editorLoaded) {
					editor.addAction({
						id: 'lsp-format-document',
						label: 'Format Document (LSP)',
						keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KeyF],
						contextMenuGroupId: 'modification',
						contextMenuOrder: 1.5,
						run: function(ed) {
							formatCode();
							return null;
						}
					});
					
					editor.addAction({
						id: 'lsp-run-diagnostics',
						label: 'Run Diagnostics',
						contextMenuGroupId: 'modification',
						contextMenuOrder: 1.6,
						run: function(ed) {
							runDiagnostics();
							return null;
						}
					});
					
					editor.addAction({
						id: 'lsp-toggle-panel',
						label: 'Toggle LSP Panel',
						keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KeyL],
						contextMenuGroupId: 'view',
						contextMenuOrder: 1.5,
						run: function(ed) {
							toggleLSPPanel();
							return null;
						}
					});
				}
			}, 1000);
		}
		
		// Initialize element caching
		document.addEventListener('DOMContentLoaded', cacheElements);
		
		// Performance monitoring
		if (typeof performance !== 'undefined') {
			window.addEventListener('load', () => {
				setTimeout(() => {
					const perfData = performance.getEntriesByType('navigation')[0];
					if (perfData && lspClient) {
						lspClient.addLog(`Page load time: ${Math.round(perfData.loadEventEnd - perfData.fetchStart)}ms`, 'info');
					}
				}, 100);
			});
		}
		
		// Error handling for LSP
		window.addEventListener('error', (event) => {
			if (lspClient) {
				lspClient.addLog(`JavaScript error: ${event.message}`, 'error');
			}
		});
		
		window.addEventListener('unhandledrejection', (event) => {
			if (lspClient) {
				lspClient.addLog(`Unhandled promise rejection: ${event.reason}`, 'error');
			}
		});
		
		// Simulate periodic LSP heartbeat
		setInterval(() => {
			if (lspClient && lspClient.isConnected) {
				// Simulate heartbeat - in real implementation this would be handled by WebSocket
				const now = new Date();
				if (now.getSeconds() % 30 === 0) { // Every 30 seconds
					lspClient.addLog('LSP heartbeat', 'info');
				}
			}
		}, 1000);
		
	</script>
</body>
</html>